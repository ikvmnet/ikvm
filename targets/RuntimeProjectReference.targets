<Project>
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <!-- 
    
        RuntimeProjectReference
        
        These references point to projects and have their produced libraries added to the project output as a runtime asset.
        
    -->

    <PropertyGroup>
        <TargetsForTfmSpecificContentInPackage>$(TargetsForTfmSpecificContentInPackage);GetRuntimeProjectReferenceContentInPackage</TargetsForTfmSpecificContentInPackage>
    </PropertyGroup>

    <Target Name="UpdateRuntimeProjectReferences" BeforeTargets="AssignProjectConfiguration" Condition=" '@(ProjectReference)' != '' ">
        <ItemGroup>
            <ProjectReference Update="@(ProjectReference)">
                <OutputItemType Condition=" '%(ProjectReference.RuntimeTargetReference)' != '' ">RuntimeTargetReferencePaths</OutputItemType>
            </ProjectReference>
        </ItemGroup>
    </Target>

    <Target Name="GetRuntimeProjectReferenceItems" DependsOnTargets="UpdateRuntimeProjectReferences" AfterTargets="ResolveProjectReferences" Condition=" '$(DesignTimeBuild)' != 'true' And '@(RuntimeTargetReferencePaths)' != '' ">
        <PropertyGroup>
            <_CompatibleRuntimeIdentifiers Condition=" '$(RuntimeIdentifier)' == '' And '$(RuntimeIdentifiers)' == '' ">;any;</_CompatibleRuntimeIdentifiers>
            <_CompatibleRuntimeIdentifiers Condition=" '$(RuntimeIdentifier)' == '' And '$(RuntimeIdentifiers)' != '' ">;$(RuntimeIdentifiers);</_CompatibleRuntimeIdentifiers>
            <_CompatibleRuntimeIdentifiers Condition=" '$(RuntimeIdentifier)' != '' ">;$(RuntimeIdentifier);</_CompatibleRuntimeIdentifiers>
            <_CompatibleRuntimeIdentifiers Condition="$(_CompatibleRuntimeIdentifiers.Contains(';win-x86;')) And '$(Prefer32Bit)' == 'false' ">;$(_CompatibleRuntimeIdentifiers);win-x64;</_CompatibleRuntimeIdentifiers>
            <_CompatibleRuntimeIdentifiers Condition="$(_CompatibleRuntimeIdentifiers.Contains(';win7-x86;')) And '$(Prefer32Bit)' == 'false' ">;$(_CompatibleRuntimeIdentifiers);win7-x64;</_CompatibleRuntimeIdentifiers>
            <_CompatibleRuntimeIdentifiers Condition="$(_CompatibleRuntimeIdentifiers.Contains(';win8-x86;')) And '$(Prefer32Bit)' == 'false' ">;$(_CompatibleRuntimeIdentifiers);win8-x64;</_CompatibleRuntimeIdentifiers>
            <_CompatibleRuntimeIdentifiers Condition="$(_CompatibleRuntimeIdentifiers.Contains(';win10-x86;')) And '$(Prefer32Bit)' == 'false' ">;$(_CompatibleRuntimeIdentifiers);win10-x64;</_CompatibleRuntimeIdentifiers>
        </PropertyGroup>
        <MatchCompatibleRuntimeIdentifierItems TargetRuntimeIdentifiers="$(_CompatibleRuntimeIdentifiers)" GroupKeyMetadataName="Filename" RuntimeIdentifierMetadataName="RuntimeTargetReference" Items="@(RuntimeTargetReferencePaths)">
            <Output TaskParameter="Items" ItemName="_RuntimeTargetReferencePaths" />
        </MatchCompatibleRuntimeIdentifierItems>
        <ItemGroup>
            <None Include="@(_RuntimeTargetReferencePaths)" Condition=" '%(_RuntimeTargetReferencePaths._Compatible)' == 'true' ">
                <TargetPath>runtimes\%(_RuntimeTargetReferencePaths.RuntimeTargetReference)\lib\%(_RuntimeTargetReferencePaths.Filename)%(_RuntimeTargetReferencePaths.Extension)</TargetPath>
                <TargetPath Condition=" '%(_RuntimeTargetReferencePaths._ManyCompatible)' != 'true' ">%(_RuntimeTargetReferencePaths.Filename)%(_RuntimeTargetReferencePaths.Extension)</TargetPath>
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Include="@(_RuntimeTargetReferencePaths->'%(RelativeDir)%(Filename).pdb')" Condition=" '%(_RuntimeTargetReferencePaths._Compatible)' == 'true' And Exists('%(_RuntimeTargetReferencePaths.RelativeDir)%(_RuntimeTargetReferencePaths.Filename).pdb') ">
                <TargetPath>runtimes\%(_RuntimeTargetReferencePaths.RuntimeTargetReference)\lib\%(_RuntimeTargetReferencePaths.Filename).pdb</TargetPath>
                <TargetPath Condition=" '%(_RuntimeTargetReferencePaths._ManyCompatible)' != 'true' ">%(_RuntimeTargetReferencePaths.Filename).pdb</TargetPath>
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
        </ItemGroup>
    </Target>

    <Target Name="GetRuntimeProjectReferenceContentInPackage" DependsOnTargets="ResolveReferences;UpdateRuntimeProjectReferences;GetRuntimeProjectReferenceItems">
        <ItemGroup>
            <TfmSpecificPackageFile Include="@(_RuntimeTargetReferencePaths)" Condition=" '%(_RuntimeTargetReferencePaths._Compatible)' == 'true' ">
                <PackagePath>runtimes\%(_RuntimeTargetReferencePaths.RuntimeTargetReference)\lib\$(TargetFramework)</PackagePath>
            </TfmSpecificPackageFile>
            <TfmSpecificPackageFile Include="@(_RuntimeTargetReferencePaths->'%(RelativeDir)%(Filename).pdb')" Condition=" '%(_RuntimeTargetReferencePaths._Compatible)' == 'true' And Exists('%(_RuntimeTargetReferencePaths.RelativeDir)%(_RuntimeTargetReferencePaths.Filename).pdb') ">
                <PackagePath>runtimes\%(_RuntimeTargetReferencePaths.RuntimeTargetReference)\lib\$(TargetFramework)</PackagePath>
            </TfmSpecificPackageFile>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <GetRuntimeProjectReferenceItemsForPackDependsOn>
            $(GetRuntimeProjectReferenceItemsForPackDependsOn);
            UpdateRuntimeProjectReferences;
            GetRuntimeProjectReferenceItems;
        </GetRuntimeProjectReferenceItemsForPackDependsOn>
    </PropertyGroup>

    <PropertyGroup>
        <AssignTargetPathsDependsOn>
            UpdateRuntimeProjectReferences;
            GetRuntimeProjectReferenceItems;
            $(AssignTargetPathsDependsOn);
        </AssignTargetPathsDependsOn>
    </PropertyGroup>

    <Target Name="ResolveRuntimeAdditionalRuntimeAssets" DependsOnTargets="GetRuntimeProjectReferenceItems" BeforeTargets="GenerateBuildDependencyFileExtensions">
        <ItemGroup>
            <AdditionalRuntimeLibraryAssets Include="@(RuntimeTargetReferencePaths)">
                <LibraryName>$(ProjectName)</LibraryName>
                <LibraryType>project</LibraryType>
                <AssetPath>runtimes\%(RuntimeTargetReference)\lib\$(TargetFramework)\%(Filename)%(Extension)</AssetPath>
                <Runtime>%(RuntimeTargetReference)</Runtime>
            </AdditionalRuntimeLibraryAssets>
        </ItemGroup>
    </Target>

</Project>
