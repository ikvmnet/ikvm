<Project>
    <PropertyGroup>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    </PropertyGroup>

    <Target Name="GetRuntimeTargetItem" Returns="@(GetRuntimeTargetItem)">
        <ItemGroup>
            <GetRuntimeTargetItem Include="$([System.IO.Path]::GetFullPath('$(TargetPath)'))">
                <TargetFramework>$(TargetFramework)</TargetFramework>
                <TargetName>$(TargetName)</TargetName>
                <TargetExt>$(TargetExt)</TargetExt>
                <DebugSymbolsPath>$([System.IO.Path]::GetFullPath('$(_DebugSymbolsIntermediatePath)'))</DebugSymbolsPath>
                <Version>$(Version)</Version>
                <CopyUpToDateMarker>@(CopyUpToDateMarker)</CopyUpToDateMarker>
            </GetRuntimeTargetItem>
        </ItemGroup>
    </Target>

    <!-- 
    
        RuntimeProjectReference
        
        These references point to projects and have their produced libraries added to the project output as a runtime asset.
        
    -->

    <Target Name="AssignRuntimeProjectConfiguration" Condition=" '$(DesignTimeBuild)' != 'true' And '@(RuntimeProjectReference)' != '' ">
        <ItemGroup>
            <_RuntimeProjectReference Include="@(RuntimeProjectReference)" />
        </ItemGroup>
        <PropertyGroup>
            <OnlyReferenceAndBuildProjectsEnabledInSolutionConfiguration Condition="'$(OnlyReferenceAndBuildProjectsEnabledInSolutionConfiguration)' == ''">true</OnlyReferenceAndBuildProjectsEnabledInSolutionConfiguration>
            <ShouldUnsetParentConfigurationAndPlatform Condition="'$(ShouldUnsetParentConfigurationAndPlatform)' == '' and ('$(BuildingInsideVisualStudio)' == 'true' or '$(BuildingSolutionFile)' == 'true')">true</ShouldUnsetParentConfigurationAndPlatform>
            <ShouldUnsetParentConfigurationAndPlatform Condition="'$(ShouldUnsetParentConfigurationAndPlatform)' == ''">false</ShouldUnsetParentConfigurationAndPlatform>
        </PropertyGroup>
        <AssignProjectConfiguration ProjectReferences="@(_RuntimeProjectReference)" CurrentProject="$(MSBuildProjectFullPath)" CurrentProjectConfiguration="$(Configuration)" CurrentProjectPlatform="$(Platform)" DefaultToVcxPlatformMapping="$(DefaultToVcxPlatformMapping)" VcxToDefaultPlatformMapping="$(VcxToDefaultPlatformMapping)" OutputType="$(OutputType)" ResolveConfigurationPlatformUsingMappings="true" SolutionConfigurationContents="$(CurrentSolutionConfigurationContents)" AddSyntheticProjectReferencesForSolutionDependencies="false" OnlyReferenceAndBuildProjectsEnabledInSolutionConfiguration="$(OnlyReferenceAndBuildProjectsEnabledInSolutionConfiguration)" ShouldUnsetParentConfigurationAndPlatform="$(ShouldUnsetParentConfigurationAndPlatform)">
            <Output TaskParameter="AssignedProjects" ItemName="__RuntimeProjectReferenceWithConfiguration"/>
            <Output TaskParameter="UnassignedProjects" ItemName="__RuntimeProjectReferenceWithConfiguration"/>
        </AssignProjectConfiguration>
        <ItemGroup>
            <_RuntimeProjectReferenceWithConfiguration Remove="@(_RuntimeProjectReferenceWithConfiguration)" />
            <_RuntimeProjectReferenceWithConfiguration Include="@(__RuntimeProjectReferenceWithConfiguration)" />
        </ItemGroup>
    </Target>

    <Target Name="_GetRuntimeProjectReferences" DependsOnTargets="AssignRuntimeProjectConfiguration" Condition=" '@(_RuntimeProjectReferenceWithConfiguration)' != '' ">
        <ItemGroup>
            <__RuntimeProjectReference Remove="@(__RuntimeProjectReference)" />
            <__RuntimeProjectReference Include="@(_RuntimeProjectReferenceWithConfiguration)">
                <ProjectName>$([System.IO.Path]::GetFileNameWithoutExtension('%(Identity)'))</ProjectName>
            </__RuntimeProjectReference>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <GetRuntimeProjectReferencesDependsOn>
            $(GetRuntimeProjectReferencesDependsOn);
            AssignRuntimeProjectConfiguration;
            _GetRuntimeProjectReferences;
        </GetRuntimeProjectReferencesDependsOn>
    </PropertyGroup>

    <Target Name="GetRuntimeProjectReferences" DependsOnTargets="$(GetRuntimeProjectReferencesDependsOn)">

    </Target>

    <Target Name="GetRuntimeProjectReferenceItems" DependsOnTargets="GetRuntimeProjectReferences" Condition=" '$(DesignTimeBuild)' != 'true' And '@(__RuntimeProjectReference)' != '' ">
        <ItemGroup>
            <_RuntimeProjectReferencesToTarget Remove="@(_RuntimeProjectReferencesToTarget)" />
            <_RuntimeProjectReferencesToTarget Include="@(__RuntimeProjectReference)">
                <Properties>%(__RuntimeProjectReference.SetConfiguration);%(__RuntimeProjectReference.SetPlatform);TargetFramework=%(__RuntimeProjectReference.TargetFramework)</Properties>
            </_RuntimeProjectReferencesToTarget>
        </ItemGroup>
        <MSBuild Projects="@(_RuntimeProjectReferencesToTarget)" Targets="Build" BuildInParallel="$(BuildInParallel)" RemoveProperties="$(_GlobalPropertiesToRemoveFromProjectReferences);RuntimeIdentifier" />
        <MSBuild Projects="@(_RuntimeProjectReferencesToTarget)" Targets="GetRuntimeTargetItem" BuildInParallel="$(BuildInParallel)" RemoveProperties="$(_GlobalPropertiesToRemoveFromProjectReferences);RuntimeIdentifier" RebaseOutputs="true">
            <Output TaskParameter="TargetOutputs" ItemName="_ResolvedRuntimeProjectReferenceTargetOutput" />
        </MSBuild>
        <ItemGroup>
            <_RuntimeProjectReferenceItems Include="@(_ResolvedRuntimeProjectReferenceTargetOutput)" />
        </ItemGroup>
    </Target>

    <Target Name="GetRuntimeProjectReferenceOutputItems" DependsOnTargets="GetRuntimeProjectReferenceItems" Condition=" '$(DesignTimeBuild)' != 'true' and '@(_RuntimeProjectReferenceItems)' != '' ">
        <ItemGroup>
            <None Include="@(_RuntimeProjectReferenceItems)" Condition=" '%(_RuntimeProjectReferenceItems.TargetFramework)' != '' ">
                <TargetPath>runtimes\%(_RuntimeProjectReferenceItems.RuntimeIdentifier)\lib\%(_RuntimeProjectReferenceItems.TargetFramework)\%(_RuntimeProjectReferenceItems.TargetName)%(_RuntimeProjectReferenceItems.TargetExt)</TargetPath>
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
                <PackagePath>runtimes\%(_RuntimeProjectReferenceItems.RuntimeIdentifier)\lib\%(_RuntimeProjectReferenceItems.TargetFramework)\%(_RuntimeProjectReferenceItems.TargetName)%(_RuntimeProjectReferenceItems.TargetExt)</PackagePath>
                <Pack Condition=" '%(_RuntimeProjectReferenceItems.Pack)' == '' ">true</Pack>
            </None>
        </ItemGroup>
    </Target>

    <Target Name="GetRuntimeProjectReferenceItemsForPack" BeforeTargets="_GetPackageFiles" DependsOnTargets="$(GetRuntimeProjectReferenceItemsForPackDependsOn)" Condition=" '$(DesignTimeBuild)' != 'true' ">
        
    </Target>

    <PropertyGroup>
        <GetRuntimeProjectReferenceItemsForPackDependsOn>
            $(GetRuntimeProjectReferenceItemsForPackDependsOn);
            GetRuntimeProjectReferences;
            GetRuntimeProjectReferenceItems;
            GetRuntimeProjectReferenceOutputItems;
        </GetRuntimeProjectReferenceItemsForPackDependsOn>
    </PropertyGroup>
    
     <PropertyGroup>
        <AssignTargetPathsDependsOn>
            GetRuntimeProjectReferences;
            GetRuntimeProjectReferenceItems;
            GetRuntimeProjectReferenceOutputItems;
            $(AssignTargetPathsDependsOn);
        </AssignTargetPathsDependsOn>
    </PropertyGroup>

    <Target Name="ResolveRuntimeAdditionalRuntimeAssets" DependsOnTargets="GetRuntimeProjectReferenceItems" BeforeTargets="ResolveBuildDependencyFileExtensions">
        <ItemGroup>
            <AdditionalRuntimeLibraryAssets Include="@(_RuntimeProjectReferenceItems->'runtimes\%(RuntimeIdentifier)\lib\%(TargetFramework)\%(TargetName)%(TargetExt)')" Condition=" '%(_RuntimeProjectReferenceItems.TargetFramework)' != '' ">
                <LibraryName>%(_RuntimeProjectReferenceItems.ProjectName)</LibraryName>
                <LibraryVersion>%(_RuntimeProjectReferenceItems.Version)</LibraryVersion>
                <LibraryType>project</LibraryType>
                <LibraryPath>%(_RuntimeProjectReferenceItems.ProjectName)/%(_RuntimeProjectReferenceItems.Version)</LibraryPath>
                <Runtime>%(_RuntimeProjectReferenceItems.RuntimeIdentifier)</Runtime>
            </AdditionalRuntimeLibraryAssets>
        </ItemGroup>
    </Target>

</Project>
