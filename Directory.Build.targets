<Project>

    <Target Name="GetLibProjectReferences">
        <MSBuild Projects="@(LibProjectReference->'%(ProjectFile)')" Targets="GetTargetPath" Properties="Platform=%(LibProjectReference.Platform);Configuration=%(LibProjectReference.Configuration)">
            <Output TaskParameter="TargetOutputs" ItemName="_LibProjectReferenceWithOutputPath" />
        </MSBuild>
        <ItemGroup>
            <LibProjectReferenceWithOutputPath Include="@(_LibProjectReferenceWithOutputPath)">
                <OutputPath>%(Identity)</OutputPath>
            </LibProjectReferenceWithOutputPath>
        </ItemGroup>
    </Target>

    <Target Name="GetItemsForLibProjectReferences" BeforeTargets="Build;AssignTargetPaths" DependsOnTargets="GetLibProjectReferences" Condition="'$(DesignTimeBuild)' != 'true'">
        <ItemGroup>
            <None Include="@(LibProjectReferenceWithOutputPath->'%(OutputPath)')">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
                <Link>%(LibProjectReferenceWithOutputPath.OutputDir)\%(LibProjectReferenceWithOutputPath.Filename)%(LibProjectReferenceWithOutputPath.Extension)</Link>
                <Pack>true</Pack>
                <PackagePath>%(LibProjectReferenceWithOutputPath.OutputDir)</PackagePath>
                <PackageCopyToOutput>true</PackageCopyToOutput>
            </None>
        </ItemGroup>
    </Target>

    <Target Name="BuildLibProjectReferences" BeforeTargets="Compile" DependsOnTargets="GetLibProjectReferences" Condition="'$(DesignTimeBuild)' != 'true'">
        <MSBuild Projects="%(LibProjectReferenceWithOutputPath.ProjectFile)" Targets="Build" Properties="Platform=%(LibProjectReferenceWithOutputPath.Platform);Configuration=%(LibProjectReferenceWithOutputPath.Configuration)">
            <Output TaskParameter="TargetOutputs" ItemName="LibProjectReferencesCompileOutput" />
        </MSBuild>
    </Target>

    <ItemGroup>
        <ProjectReference Include="@(PublishProjectReference)">
            <Private>false</Private>
            <IncludeAssets>none</IncludeAssets>
            <ExcludeAssets>all</ExcludeAssets>
            <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
            <CopyLocalSatelliteAssemblies>false</CopyLocalSatelliteAssemblies>
            <SetTargetFramework>%(SetTargetFramework)</SetTargetFramework>
            <PublishTargetPath>%(TargetPath)</PublishTargetPath>
            <PublishProperties>%(Properties)</PublishProperties>
        </ProjectReference>
    </ItemGroup>

    <Target Name="GetPublishProjectReferences" DependsOnTargets="ResolveProjectReferences">
        <ItemGroup>
            <PublishProjectReference Include="@(ProjectReferenceWithConfiguration)" Condition="'%(ProjectReferenceWithConfiguration.PublishTargetPath)' != ''">
                <ProjectName>$([System.IO.Path]::GetFileNameWithoutExtension('%(Identity)'))</ProjectName>
                <PublishTargetPath>$([MSBuild]::EnsureTrailingSlash(%(ProjectReferenceWithConfiguration.PublishTargetPath)))</PublishTargetPath>
            </PublishProjectReference>
        </ItemGroup>
    </Target>

    <Target Name="GetPublishProjectReferenceOutputItems" DependsOnTargets="GetPublishProjectReferences" Inputs="@(PublishProjectReference)" Outputs="%(PublishProjectReference.Identity)\dummy">
        <MSBuild Projects="@(PublishProjectReference)" Targets="Publish;PublishItemsOutputGroup" BuildInParallel="$(BuildInParallel)" Properties="%(PublishProjectReference.SetConfiguration);%(PublishProjectReference.SetPlatform);%(PublishProjectReference.SetTargetFramework);%(PublishProjectReference.PublishProperties)" RemoveProperties="%(PublishProjectReference.GlobalPropertiesToRemove);%(PublishProjectReference.PublishPropertiesToRemove);" RebaseOutputs="true">
            <Output TaskParameter="TargetOutputs" ItemName="_PublishProjectReferenceOutputItems" />
        </MSBuild>
    </Target>

    <Target Name="_GetPublishProjectReferenceCopyToOutputDirectoryItems" DependsOnTargets="GetPublishProjectReferenceOutputItems">
        <ItemGroup>
            <ContentWithTargetPath Include="@(_PublishProjectReferenceOutputItems)" Condition=" '%(_PublishProjectReferenceOutputItems.TargetPath)' != '' ">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
                <TargetPath>%(_PublishProjectReferenceOutputItems.PublishTargetPath)\%(_PublishProjectReferenceOutputItems.TargetPath)</TargetPath>
            </ContentWithTargetPath>
        </ItemGroup>
    </Target>

    <PropertyGroup>
        <GetPublishProjectReferenceCopyToOutputDirectoryItemsDependsOn>
            $(GetPublishProjectReferenceCopyToOutputDirectoryItemsDependsOn);
            GetPublishProjectReferences;
            GetPublishProjectReferenceOutputItems;
            _GetPublishProjectReferenceCopyToOutputDirectoryItems;
        </GetPublishProjectReferenceCopyToOutputDirectoryItemsDependsOn>
    </PropertyGroup>

    <Target Name="GetPublishProjectReferenceCopyToOutputDirectoryItems" DependsOnTargets="$(GetPublishProjectReferenceCopyToOutputDirectoryItemsDependsOn)" BeforeTargets="GetCopyToOutputDirectoryItems">

    </Target>

</Project>